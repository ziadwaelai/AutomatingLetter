# Usage Tracking and Cost Calculation Service

## Overview

The `UsageTrackingService` automatically tracks token usage and cost for every letter generated by the AI system. It calculates the number of input and output tokens, estimates the cost in USD, and updates a "Usage" sheet in the user's Google Sheet with monthly aggregated statistics.

It also enforces monthly quota limits to prevent excessive generation, checking the "Settings" sheet before allowing letter generation.

## Features

✅ **Token Counting** - Accurate token counting using OpenAI's tiktoken library  
✅ **Cost Calculation** - Estimates USD cost based on OpenAI pricing models  
✅ **Monthly Aggregation** - Tracks usage per month in yyyy_mm format  
✅ **Automatic Updates** - Automatically updates Google Sheets with usage data  
✅ **Multiple Model Support** - Supports gpt-4o, gpt-4-turbo, gpt-3.5-turbo pricing  
✅ **Quota Enforcement** - Checks monthly limits before generation from Settings sheet  
✅ **Error Handling** - Graceful fallback if tracking fails; letter still generates  

## File Structure

### New Service File
- **`src/services/usage_tracking_service.py`** - Main usage tracking service

### Modified Files
- **`src/api/letter_routes.py`** - Integrated usage tracking into /generate endpoint
- **`src/services/__init__.py`** - Added service exports

## Usage Statistics Sheet Format

The service tracks usage in a "Usage" sheet with the following columns:

| Column | Type | Description |
|--------|------|-------------|
| `yyyy_mm` | String | Month in format YYYY_MM (e.g., "2024_10") |
| `letters_count` | Number | Total letters generated this month |
| `tokens_sum` | Number | Total tokens used this month |
| `cost_sum_usd` | Float | Total cost in USD this month |

### Example Data
```
yyyy_mm   | letters_count | tokens_sum | cost_sum_usd
2024_10   | 15            | 45600      | 2.84
2024_11   | 22            | 68900      | 4.12
```

## Settings Sheet Format (Quota Configuration)

The service checks a "Settings" sheet for quota limits with the following format:

| Column | Type | Description |
|--------|------|-------------|
| `key` | String | Setting key name |
| `value` | String/Number | Setting value |

### Quota Configuration Example
```
key           | value
quota_month   | 100
```

The `quota_month` key defines the maximum number of letters a user can generate per month. When a user exceeds this limit, the `/api/v1/letter/generate` endpoint returns a 429 error with details about the quota.

## Quota Enforcement Flow

1. **User requests letter generation** → POST `/api/v1/letter/generate`
2. **Service checks quota** → Reads `quota_month` from Settings sheet
3. **Current month usage checked** → Reads letters_count from Usage sheet
4. **Comparison made**:
   - If `current_count < quota_limit` → Continue with generation
   - If `current_count >= quota_limit` → Return 429 error, block generation
5. **If allowed**: Generate letter and increment `letters_count`

### Quota Response (Exceeded)

```json
{
  "error": "تم تجاوز حد الخطابات الشهري",
  "message": "Monthly letter quota has been reached",
  "quota_info": {
    "current_count": 100,
    "quota_limit": 100
  }
}
```
HTTP Status: 429 Too Many Requests

### Quota Response (Allowed)

Generation continues normally, letter returned with usage info and updated counts.

## Architecture

### Main Service Class: `UsageTrackingService`

#### Key Methods

**`count_tokens(text: str) -> int`**
- Counts tokens in text using tiktoken
- Supports cl100k_base encoding (used by GPT-3.5, GPT-4)
- Fallback to character estimation if tokenization fails

**`calculate_cost(input_tokens, output_tokens, model) -> float`**
- Calculates cost based on token counts and model pricing
- Returns cost rounded to 6 decimal places
- Supports multiple OpenAI models

**`estimate_usage(prompt, response, model) -> Dict`**
- Complete estimation for a prompt-response pair
- Returns dictionary with:
  - `input_tokens` - Tokens in the input prompt
  - `output_tokens` - Tokens in the AI response
  - `total_tokens` - Sum of input and output
  - `cost_usd` - Total cost
  - `model` - Model used

**`get_current_month_key() -> str`**
- Returns current month in "yyyy_mm" format
- Example: "2024_10" for October 2024

**`get_or_create_usage_row(sheet_id, month_key) -> Tuple[int, Dict]`**
- Finds or creates a row for the current month
- Searches "Usage" sheet for matching month
- Creates new row if month doesn't exist
- Returns (row_number, row_data)

**`update_usage(sheet_id, tokens_used, cost_usd) -> Dict`**
- Updates the Usage sheet for current month
- Increments `letters_count` by 1
- Adds tokens to `tokens_sum`
- Adds cost to `cost_sum_usd`
- Returns update result with new totals

**`get_quota_limit(sheet_id) -> Optional[int]`**
- Reads quota limit from Settings sheet (key: "quota_month")
- Returns the monthly letter limit as integer
- Returns None if not configured
- No quota limit means unlimited generation

**`check_quota(sheet_id) -> Dict`**
- Checks if current month quota has been exceeded
- Compares current_count from Usage sheet with quota_limit
- Returns dictionary with:
  - `status`: "allowed" or "exceeded"
  - `current_count`: Letters generated this month
  - `quota_limit`: Maximum letters per month
  - `remaining`: Remaining letters (if allowed)
  - `reason`: Description of status
- Fails open (allows generation) if quota check errors

### Pricing Model

The service includes built-in pricing for OpenAI models:

```python
PRICING = {
    "gpt-4o": {
        "input": 0.005 / 1000,      # $0.005 per 1K tokens
        "output": 0.015 / 1000,     # $0.015 per 1K tokens
    },
    "gpt-4-turbo": {
        "input": 0.01 / 1000,       # $0.01 per 1K tokens
        "output": 0.03 / 1000,      # $0.03 per 1K tokens
    },
    "gpt-3.5-turbo": {
        "input": 0.0005 / 1000,     # $0.0005 per 1K tokens
        "output": 0.0015 / 1000,    # $0.0015 per 1K tokens
    }
}
```

**Note:** Pricing rates are approximate and based on 2024-2025 OpenAI rates. Update the PRICING dictionary if rates change.

## Integration with Letter Generation

### Generation Endpoint Flow

1. **User sends request** to `/api/v1/letter/generate` with letter parameters
2. **JWT authenticated** - extracts user info and sheet_id
3. **Letter generated** by ArabicLetterGenerationService
4. **Usage tracked** (optional - doesn't block if it fails):
   - Build prompt text from generation context
   - Call `estimate_usage()` to count tokens and calculate cost
   - Call `update_usage()` to update the Usage sheet
5. **Response sent** with usage information in body:
   ```json
   {
     "ID": "LETTER_ID",
     "Title": "...",
     "Letter": "...",
     "usage": {
       "input_tokens": 1234,
       "output_tokens": 456,
       "total_tokens": 1690,
       "cost_usd": 0.0285
     }
   }
   ```

### Response Example

```json
{
  "ID": "LTR_2024_001",
  "Title": "Letter Title",
  "Letter": "Letter content...",
  "usage": {
    "input_tokens": 2450,
    "output_tokens": 1820,
    "total_tokens": 4270,
    "cost_usd": 0.1065
  }
}
```

## Usage Tracking Process

### Step-by-Step

1. **Prompt Assembly**: Full prompt with instructions, context, and reference templates
2. **Response Generation**: AI generates the letter
3. **Token Counting**:
   - Input tokens counted from complete prompt
   - Output tokens counted from generated letter
   - Uses tiktoken for accuracy
4. **Cost Calculation**:
   - Input cost = input_tokens × input_price_per_token
   - Output cost = output_tokens × output_price_per_token
   - Total cost = input_cost + output_cost
5. **Sheet Update**:
   - Find or create row for current month (yyyy_mm)
   - Increment letters_count
   - Add tokens to tokens_sum
   - Add cost to cost_sum_usd
   - Update all cells via Google Sheets API

### Monthly Aggregation Example

For October 2024:
- Letter 1: 1200 tokens, $0.0342
- Letter 2: 1450 tokens, $0.0425
- Letter 3: 2100 tokens, $0.0598

Monthly Total:
- `yyyy_mm`: "2024_10"
- `letters_count`: 3
- `tokens_sum`: 4750
- `cost_sum_usd`: 0.1365

## Error Handling

### Graceful Degradation

If usage tracking fails for any reason:

1. **Logging**: Error is logged with details
2. **Response**: Letter is still returned successfully
3. **Flag**: Optional `usage_error` field added to response
4. **Transparency**: User can see tracking failed in response

```json
{
  "ID": "LTR_2024_001",
  "Title": "Letter Title",
  "Letter": "Letter content...",
  "usage_error": "Failed to update Usage sheet: ..."
}
```

### Common Issues

| Issue | Solution |
|-------|----------|
| Usage sheet doesn't exist | Service creates it automatically with headers |
| Sheet permission denied | Check Google Sheets API permissions |
| Invalid month format | Service uses `datetime.now().strftime("%Y_%m")` |
| Token count too high | Might indicate very long prompts; check input validation |

## Configuration

### Current Settings

- **Model**: gpt-4o (configured in letter generation)
- **Encoding**: cl100k_base (standard for GPT models)
- **Sheet Name**: "Usage"
- **Month Format**: yyyy_mm (e.g., "2024_10")
- **Settings Sheet**: "Settings" with key-value pairs
- **Quota Key**: "quota_month" defines maximum letters per month

### Quota Configuration

To set up monthly quota limits:

1. **Create/Edit Settings Sheet** in user's Google Sheet
2. **Add quota row**:
   ```
   key          | value
   quota_month  | 100
   ```
3. **Quota is now enforced** - Users cannot generate more than 100 letters per month
4. **No quota** - Leave Settings sheet empty or remove quota_month to allow unlimited generation

### Quota Examples

| quota_month Value | Behavior |
|-------------------|----------|
| 100 | Max 100 letters per month |
| 500 | Max 500 letters per month |
| Not set | Unlimited letters per month |
| 0 | No letters allowed (special case) |

### Customization

To modify token counting, pricing, or quota:

1. **Change Pricing**:
   ```python
   # In usage_tracking_service.py, update PRICING dictionary
   PRICING["gpt-4o"]["input"] = 0.006 / 1000  # New rate
   ```

2. **Change Encoding**:
   ```python
   # Different encoding for different models
   self.encoding = tiktoken.get_encoding("cl100k_base")  # or other
   ```

3. **Change Sheet Names**:
   ```python
   # In methods, change hardcoded sheet names
   worksheet = spreadsheet.worksheet("CustomUsageSheet")
   worksheet = spreadsheet.worksheet("CustomSettingsSheet")
   ```

4. **Modify Quota Error Response**:
   ```python
   # In letter_routes.py generate_letter() method
   return jsonify({
       "error": "Custom error message",
       "quota_info": {...}
   }), 429
   ```

## Monitoring and Reporting

### Monthly Reports

Query the Usage sheet to generate monthly reports:

```sql
-- Example: Total tokens and cost for October 2024
SELECT yyyy_mm, letters_count, tokens_sum, cost_sum_usd 
FROM Usage 
WHERE yyyy_mm = "2024_10"
```

### Trending Analysis

Track month-to-month trends:

```sql
-- Cost per letter by month
SELECT yyyy_mm, letters_count, 
       ROUND(cost_sum_usd / letters_count, 4) as cost_per_letter,
       tokens_sum
FROM Usage
ORDER BY yyyy_mm DESC
```

## Testing

### Manual Testing

1. **Generate a letter** via `/api/v1/letter/generate`
2. **Check response** for `usage` field
3. **Verify Usage sheet** was updated with:
   - Current month row created or incremented
   - Letter count +1
   - Tokens added correctly
   - Cost calculated correctly

### Quota Testing

1. **Set up quota** in Settings sheet:
   ```
   key          | value
   quota_month  | 5
   ```

2. **Generate 5 letters** - All should succeed and appear in response with usage info

3. **Generate 6th letter** - Should fail with 429 error:
   ```json
   {
     "error": "تم تجاوز حد الخطابات الشهري",
     "message": "Monthly letter quota has been reached",
     "quota_info": {
       "current_count": 5,
       "quota_limit": 5
     }
   }
   ```

4. **Verify Usage sheet** shows letters_count = 5 for current month

5. **Test quota removal**:
   - Delete or comment out `quota_month` row in Settings sheet
   - Generate another letter - Should succeed (quota now unlimited)

### Token Counting Test

```python
from src.services.usage_tracking_service import get_usage_tracking_service

service = get_usage_tracking_service()

# Test token counting
text = "This is a test message"
tokens = service.count_tokens(text)
print(f"Tokens: {tokens}")

# Test cost calculation
cost = service.calculate_cost(1000, 500, "gpt-4o")
print(f"Cost: ${cost:.6f}")

# Test full estimation
usage = service.estimate_usage("Hello world", "Hi there!", "gpt-4o")
print(f"Usage: {usage}")

# Test quota checking
quota_check = service.check_quota(sheet_id="your_sheet_id")
print(f"Quota status: {quota_check['status']}")
print(f"Current: {quota_check.get('current_count')}, Limit: {quota_check.get('quota_limit')}")
```

## Notes and Limitations

⚠️ **Token Estimation**: Token counts are estimates based on tiktoken. Actual OpenAI usage may vary slightly due to:
- Different tokenization in edge cases
- Special characters handling
- JSON formatting overhead

⚠️ **Pricing Accuracy**: Pricing is approximate and may change. Not suitable for billing without official OpenAI API calls.

⚠️ **Performance**: First-time usage tracking adds ~500ms overhead (Google Sheets API call).

⚠️ **Fallback Estimation**: If tiktoken fails, character count ÷ 4 is used as fallback estimate.

## Future Enhancements

Potential improvements for future versions:

- [ ] Real token counts from OpenAI API responses
- [ ] Per-user cost tracking and limits
- [ ] Cost alerts when exceeding thresholds
- [ ] Detailed cost breakdown by model
- [ ] Historical cost trend visualization
- [ ] Estimated remaining budget calculation
- [ ] Integration with billing system

## Troubleshooting

### Usage not updating

**Problem**: Usage sheet not being updated after letter generation  
**Check**:
1. Usage sheet exists in user's Google Sheet
2. Column names are exactly: yyyy_mm, letters_count, tokens_sum, cost_sum_usd
3. Service account has write permissions
4. Check logs for tracking errors

### Incorrect token counts

**Problem**: Token counts seem too high or too low  
**Check**:
1. Verify prompt assembly includes all context
2. Check if response truncation is happening
3. Use manual test to verify tiktoken counts

### Sheet permission errors

**Problem**: "Permission denied" error when updating Usage sheet  
**Fix**:
1. Ensure service account has write access
2. Check sheet_id is correct
3. Verify Google Sheets API is enabled

## Related Documentation

- [Letter Generation API](./API_DOCUMENTATION.md)
- [Google Sheets Integration](./COMPLETE_PROJECT_DOCUMENTATION.md)
- [JWT Authentication](./USER_MANAGEMENT_API.md)

